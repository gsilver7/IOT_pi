{"version":3,"file":"rtpTransceiver.js","sourceRoot":"","sources":["../../../../src/media/rtpTransceiver.ts"],"names":[],"mappings":"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","sourcesContent":["import * as uuid from \"uuid\";\nimport { Event } from \"../imports/common\";\n\nimport type { RTCDtlsTransport } from \"..\";\nimport { SenderDirections } from \"../const\";\nimport type { Kind } from \"../types/domain\";\nimport type {\n  RTCRtpCodecParameters,\n  RTCRtpHeaderExtensionParameters,\n} from \"./parameters\";\nimport type { RTCRtpReceiver } from \"./rtpReceiver\";\nimport type { RTCRtpSender } from \"./rtpSender\";\nimport {\n  type RTCCodecStats,\n  type RTCStats,\n  generateStatsId,\n  getStatsTimestamp,\n} from \"./stats\";\nimport type { MediaStream, MediaStreamTrack } from \"./track\";\n\nexport class RTCRtpTransceiver {\n  readonly id = uuid.v4();\n  readonly onTrack = new Event<[MediaStreamTrack, RTCRtpTransceiver]>();\n  mid?: string;\n  mLineIndex?: number;\n  /**should not be reused because it has been used for sending before. */\n  usedForSender = false;\n  private _currentDirection?: MediaDirection;\n  offerDirection!: MediaDirection;\n  _codecs: RTCRtpCodecParameters[] = [];\n  set codecs(codecs: RTCRtpCodecParameters[]) {\n    this._codecs = codecs;\n  }\n  get codecs() {\n    return this._codecs;\n  }\n  headerExtensions: RTCRtpHeaderExtensionParameters[] = [];\n  options: Partial<TransceiverOptions> = {};\n  stopping = false;\n  stopped = false;\n\n  constructor(\n    public readonly kind: Kind,\n    dtlsTransport: RTCDtlsTransport | undefined,\n    public receiver: RTCRtpReceiver,\n    public sender: RTCRtpSender,\n    /**RFC 8829 4.2.4.  direction the transceiver was initialized with */\n    private _direction: MediaDirection,\n  ) {\n    if (dtlsTransport) {\n      this.setDtlsTransport(dtlsTransport);\n    }\n  }\n\n  get dtlsTransport() {\n    return this.receiver.dtlsTransport;\n  }\n\n  /**RFC 8829 4.2.4. setDirectionに渡された最後の値を示します */\n  get direction() {\n    return this._direction;\n  }\n\n  setDirection(direction: MediaDirection) {\n    this._direction = direction;\n    if (SenderDirections.includes(this._currentDirection ?? \"\")) {\n      this.usedForSender = true;\n    }\n  }\n\n  /**RFC 8829 4.2.5. last negotiated direction */\n  get currentDirection(): MediaDirection | undefined {\n    return this._currentDirection;\n  }\n\n  setCurrentDirection(direction: MediaDirection | undefined) {\n    this._currentDirection = direction;\n  }\n\n  setDtlsTransport(dtls: RTCDtlsTransport) {\n    this.receiver.setDtlsTransport(dtls);\n    this.sender.setDtlsTransport(dtls);\n  }\n\n  get msid() {\n    return `${this.sender.streamId} ${this.sender.trackId}`;\n  }\n\n  addTrack(track: MediaStreamTrack) {\n    const res = this.receiver.addTrack(track);\n    if (res) {\n      this.onTrack.execute(track, this);\n    }\n  }\n\n  // todo impl\n  // https://www.w3.org/TR/webrtc/#methods-8\n  stop() {\n    if (this.stopping) {\n      return;\n    }\n\n    // todo Stop sending and receiving with transceiver.\n\n    this.stopping = true;\n  }\n\n  getPayloadType(mimeType: string) {\n    return this.codecs.find((codec) =>\n      codec.mimeType.toLowerCase().includes(mimeType.toLowerCase()),\n    )?.payloadType;\n  }\n\n  getCodecStats(): RTCStats[] {\n    const timestamp = getStatsTimestamp();\n    const stats: RTCStats[] = [];\n\n    if (!this.dtlsTransport) {\n      return stats;\n    }\n\n    const transportId = generateStatsId(\"transport\", this.dtlsTransport.id);\n\n    // Add codec stats for each codec\n    for (const codec of this.codecs) {\n      const codecStats: RTCCodecStats = {\n        type: \"codec\",\n        id: generateStatsId(\"codec\", codec.payloadType, transportId),\n        timestamp,\n        payloadType: codec.payloadType,\n        transportId,\n        mimeType: codec.mimeType,\n        clockRate: codec.clockRate,\n        channels: codec.channels,\n        sdpFmtpLine: codec.parameters,\n      };\n      stats.push(codecStats);\n    }\n\n    return stats;\n  }\n}\n\nexport const Inactive = \"inactive\";\nexport const Sendonly = \"sendonly\";\nexport const Recvonly = \"recvonly\";\nexport const Sendrecv = \"sendrecv\";\n\nexport const Directions = [Inactive, Sendonly, Recvonly, Sendrecv] as const;\n\nexport type MediaDirection = (typeof Directions)[number];\n\ntype SimulcastDirection = \"send\" | \"recv\";\n\nexport interface TransceiverOptions {\n  direction: MediaDirection;\n  simulcast: { direction: SimulcastDirection; rid: string }[];\n  streams: MediaStream[];\n}\n"]}